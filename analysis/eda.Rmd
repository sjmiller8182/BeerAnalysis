---
title: "Beer_Analysis_EDA"
author: "Kevin Thompson and Stuart Miller"
date: "6/16/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

### Load Libraries

```{r libraries, message=FALSE}
library(tidyverse)
library(ggplot2)
library(reshape2)
```

### Load Data 

Be sure to run `make` in `./analysis/data` first.

```{r}
load('./data/.RData')
```

# EDA 

The file contains base EDA preformed. This will be followed with a final analysis file.

## Method

1. Start with preliminaries - structure of data.
2. Use questions of assignment as EDA guide and expand where interested.

## Structure of Data

```{r}
# just use `str`
str(beer_data)
str(brewery_data)
```

Most columns are factors or characters. `ABV` and `IBU` are the only numeric columns.

## EDA

### Look at breweries and beers per state and city

```{r fig.width=15, fig.height=7}
# get counts of breweries per state
brewerysPerState <- brewery_data %>% 
  group_by(State) %>% 
  summarise(Brewery_name = length(State))
# order the result
brewerysPerState <- brewerysPerState[order(-brewerysPerState$Brewery_name), ]
# better name for column
names(brewerysPerState)[2] <- 'BreweryCount'
# plot count vs state (bar)
ggplot(data=brewerysPerState, aes(x = reorder(State, -BreweryCount), y = BreweryCount)) +
  geom_bar(stat = 'identity') +
  xlab('State') +
  ylab('Count') +
  ggtitle('Brewery Count per State')
```

```{r fig.width=15, fig.height=7}
# get counts of breweries per state
beersPerState <- merged_data %>% 
  group_by(State) %>% 
  summarise(Beer_ID = length(State))
# order the result
beersPerState <- beersPerState[order(-beersPerState$Beer_ID), ]
# better name for column
names(beersPerState)[2] <- 'BreweryCount'
# plot count vs state (bar)
ggplot(data=beersPerState, aes(x = reorder(State, -BreweryCount), y = BreweryCount)) +
  geom_bar(stat = 'identity') +
  xlab('State') +
  ylab('Count') +
  ggtitle('Beer Count per State')
```

Look at number of breweries per city. Subset on top 20 as there are a large number of cities in the data set.

```{r fig.width=15, fig.height=7}
# get counts of breweries per state
brewerysPerCity <- brewery_data %>% 
  group_by(City) %>% 
  summarise(Brewery_name = length(City))
# order the result
brewerysPerCity <- brewerysPerCity[order(-brewerysPerCity$Brewery_name), ]
# better name for column
names(brewerysPerCity)[2] <- 'BreweryCount'
# plot count vs state (bar)
ggplot(data=head(brewerysPerCity,20), aes(x = reorder(City, -BreweryCount), y = BreweryCount)) +
  geom_bar(stat = 'identity') +
  xlab('City') +
  ylab('Count') +
  ggtitle('Brewery Count per City')
```

```{r fig.width=15, fig.height=7}
# get counts of breweries per state
beersPerCity <- merged_data %>% 
  group_by(City) %>% 
  summarise(Beer_ID = length(City))
# order the result
beersPerCity <- beersPerCity[order(-beersPerCity$Beer_ID), ]
# better name for column
names(beersPerCity)[2] <- 'BeerCount'
# plot count vs state (bar)
ggplot(data=head(beersPerCity,20), aes(x = reorder(City, -BeerCount), y = BeerCount)) +
  geom_bar(stat = 'identity') +
  xlab('City') +
  ylab('Count') +
  ggtitle('Beer Count per City')
```

Interestingly, the city with the highest number of breweries and highest number of unique beers do not match. For example, Grand Rapids has the highest number of unique beers, but is not in the top 20 cities of brewery count. This may have to do with how big name 'chain' breweries are distributed over cities and state.

### Verify merged data looks correct

Since data was merged in `make` step, just check to make sure it looks right.

```{r}
head(merged_data)
tail(merged_data)
```

Data appear to be correcly merged based on head and tail of `data.frame()`. However, this would only catch gross errors in merge.

### Look at `NA`s in columns of merged data

Only columns `IBU` and `ABV` have missing data.

```{r}
nas.in.merged.data <- colSums(is.na(merged_data))
nas.in.merged.data
```

Look at missing data as a percent of the total for `IBU` and `ABV`.

```{r}

(nas.in.merged.data/length(merged_data$IBU)*100)[c(7,8)]

```

The table below, shows the number of missing values (`NA`) for `IBU` and `ABV`. No other columns are missing values. A large portion of the `IBU` values are missing, which would affect insightes related to `IBU`. The number of missing values for `ABV` is less significant, but caution should be taken when working with this column.

| Column Name   | Number of Missing Values| Percent of Values Missing|
|:-------------:|------------------------:|-------------------------:|
| IBU           | 1005                    |41.70%                    |
| ABV           | 62                      |2.57%                     |

These missing data summaries suggests the question: 'how are these missing values distributed over the factors?' Look at missing IBU values per state. 

```{r}
# function to aggregate missing values in column by factor
nacheck <- function(var, factor)
    aggregate(var, list(factor), function(x) sum(is.na(x)))
```


```{r}
# count beers per state because IBU and ABV are
# per beer i.e. per beer ID
BeerCountPerState <- merged_data %>% 
  group_by(State) %>% 
  summarise(Beer_ID = length(State))
# pick some better names
names(BeerCountPerState) <- c('State','CountOfBeerID')

# get missing IBU values by state
MissingIBUPerState <- nacheck(merged_data$IBU, merged_data$State)
# pick some better names
names(MissingIBUPerState) <- c('State','MissingIBUCount')

# calculate percentage of missing IBU values per state
MissingIBUPerState$PercentIBUMissing <- 
  MissingIBUPerState$MissingIBUCount/BeerCountPerState$CountOfBeerID

# get missing ABV values by state
MissingABVPerState <- nacheck(merged_data$ABV, merged_data$State)
# pick some better names
names(MissingABVPerState) <- c('State','MissingABVCount')

# calculate percentage of missing ABV values per state
MissingABVPerState$PercentABVMissing <- 
  MissingABVPerState$MissingABVCount/BeerCountPerState$CountOfBeerID
```

```{r fig.width=15, fig.height=7}
# plot % missing IBU values vs state (bar)
ggplot(data=MissingIBUPerState, aes(x = reorder(State, -PercentIBUMissing), y = PercentIBUMissing)) +
  geom_bar(stat = 'identity') +
  xlab('State') +
  ylab('Percent Missing IBU Values') +
  ggtitle('Percent of Missing IBU values per State')
```

A large number of states are heavily affected by the missing values of IBU.

```{r fig.width=15, fig.height=7}
# plot % missing ABV values vs state (bar)
ggplot(data=MissingABVPerState, aes(x = reorder(State, -PercentABVMissing), y = PercentABVMissing)) +
  geom_bar(stat = 'identity') +
  xlab('State') +
  ylab('Percent Missing ABV Values') +
  ggtitle('Percent of Missing ABV values per State')
```

A small number of states are heavily affected by the missing values of `ABV`, primarily, Delaware, Nebraska, and Nevada.

### Cursory Look at `IBU` and `ABV`

* Alcohol content is labeled `ABV`.
* International bitterness unit is labled `IBU`.

Look at histograms for `IBU` and `ABV`. `NA`s will be removed for histograms.

```{r}
# plot distributions of `ABV` and `IBU`
ggplot(data = merged_data, aes(x = ABV)) + geom_histogram(bins = 30)
ggplot(data = merged_data, aes(x = IBU)) + geom_histogram(bins = 30)
```

### **Statistical Summary Calculations for `IBU` and `ABV`**

Calcaculate summary statistics for `IBU` and `ABV`. It will be necessary to remove rows with `NA` to make summary calculations.

```{r}
# calc summary stats for IBU
IBUByState <- merged_data %>% 
  filter(!is.na(IBU)) %>%
  group_by(State) %>% 
  summarise(Mean=mean(IBU), Max=max(IBU), Min=min(IBU), Median=median(IBU), Std=sd(IBU))
```

```{r}
# calc summary stats for ABV
ABVByState <- merged_data %>% 
  filter(!is.na(ABV)) %>%
  group_by(State) %>% 
  summarise(Mean=mean(ABV), Max=max(ABV), Min=min(ABV), Median=median(ABV), Std=sd(ABV))
```

Look at summary stats side-by-side.

```{r}
# melt ByState data.frames to view stats side-by-side
IBUByState.long<-melt(IBUByState, id.vars = 'State')
ABVByState.long<-melt(ABVByState, id.vars = 'State')
```

#### Plots of `IBU` Statistics Per State

```{r fig.width=15, fig.height=7}
ggplot(IBUByState.long[IBUByState.long$variable %in% c('Mean','Median'), ], 
       aes(x=State, y=value, fill = variable)) +
    geom_bar(stat='identity', position='dodge') +
  ggtitle('Mean and Median of IBU per State') +
  xlab('State') + ylab('Statistic Value')
```



```{r fig.width=15, fig.height=7}
ggplot(IBUByState.long[IBUByState.long$variable %in% c('Mean','Std'), ], 
       aes(x=State, y=value, fill = variable)) +
    geom_bar(stat='identity', position='dodge') +
  ggtitle('Mean and Standard Deviation of IBU per State') +
  xlab('State') + ylab('Statistic Value')
```

```{r fig.width=15, fig.height=7}
ggplot(IBUByState.long[IBUByState.long$variable %in% c('Max','Min'), ], 
       aes(x=State, y=value, fill = variable)) +
    geom_bar(stat='identity', position='dodge') +
  ggtitle('Max and Min of IBU per State') +
  xlab('State') + ylab('Statistic Value')
```

#### Plots of `ABV` Statistics Per State

```{r fig.width=15, fig.height=7}
ggplot(ABVByState.long[ABVByState.long$variable %in% c('Mean','Median'), ], 
       aes(x=State, y=value, fill = variable)) +
    geom_bar(stat='identity', position='dodge') +
  ggtitle('Mean and Median of ABV per State') +
  xlab('State') + ylab('Statistic Value')
```

```{r fig.width=15, fig.height=7}
ggplot(ABVByState.long[ABVByState.long$variable %in% c('Mean','Std'), ], 
       aes(x=State, y=value, fill = variable)) +
    geom_bar(stat='identity', position='dodge') +
  ggtitle('Mean and Standard Deviation of ABV per State') +
  xlab('State') + ylab('Statistic Value')
```

```{r fig.width=15, fig.height=7}
ggplot(ABVByState.long[ABVByState.long$variable %in% c('Max','Min'), ], 
       aes(x=State, y=value, fill = variable)) +
    geom_bar(stat='identity', position='dodge') +
  ggtitle('Max and Min of ABV per State') +
  xlab('State') + ylab('Statistic Value')
```
